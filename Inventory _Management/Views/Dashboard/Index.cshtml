@{
    ViewData["Title"] = "Dashboard";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

<style>
    body {
        background-color: #f5f7fa;
        font-family: "Segoe UI", Roboto, Arial, sans-serif;
    }

    h2.page-title {
        color: #212529;
        text-align: left;
        margin: 18px 0;
        font-weight: 600;
    }

    .btn-refresh {
        border-radius: 8px;
        padding: 6px 14px;
        font-weight: 600;
    }

    .summary-row {
        margin-bottom: 18px;
    }

    .dash-card {
        background: linear-gradient(180deg, #ffffff 0%, #f1f5fb 100%);
        border: 1px solid rgba(30, 41, 59, 0.06);
        border-radius: 12px;
        padding: 18px;
        text-align: center;
        transition: transform .14s ease, box-shadow .14s ease;
        cursor: pointer;
        height: 100%;
    }

        .dash-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
        }

        .dash-card .icon {
            font-size: 28px;
            color: #0d6efd;
            margin-bottom: 6px;
        }

        .dash-card h6 {
            margin-bottom: 6px;
            color: #495057;
            font-weight: 600;
        }

        .dash-card h3 {
            margin: 0;
            font-size: 28px;
            color: #0f1724;
        }

    .chart-card {
        background: #fff;
        border: 1px solid rgba(15, 23, 42, 0.06);
        border-radius: 10px;
        padding: 14px;
        height: 100%;
    }

        .chart-card h6 {
            margin-bottom: 10px;
            font-weight: 600;
            color: #343a40;
        }

    .chart-wrap {
        height: 360px;
        position: relative;
        padding-bottom: 8px;
    }

    #pieTooltip {
        position: fixed;
        display: none;
        background: white;
        border: 1px solid rgba(0,0,0,0.08);
        padding: 12px;
        border-radius: 8px;
        pointer-events: none;
        font-size: 0.9rem;
        z-index: 2000;
        box-shadow: 0 6px 18px rgba(32,33,36,0.08);
        max-width: 320px;
    }

        #pieTooltip .title {
            font-weight: 700;
            margin-bottom: 6px;
            color: #0d6efd;
        }

        #pieTooltip .product-line {
            display: block;
            margin: 2px 0;
        }

    #recentTable tbody tr:hover {
        background: rgba(13,110,253,0.03);
    }

    .badge-active {
        background-color: #28a745;
        color: white;
        padding: 4px 9px;
        border-radius: 12px;
        font-size: 0.82rem;
        font-weight: 600;
    }

    .badge-inactive {
        background-color: #dc3545;
        color: white;
        padding: 4px 9px;
        border-radius: 12px;
        font-size: 0.82rem;
        font-weight: 600;
    }

    .stock-low {
        background-color: #ffcc99 !important;
        border: 1px solid #ff9900;
        color: #a05200;
        font-weight: 700;
        padding: 4px 12px;
        border-radius: 12px;
        display: inline-block;
        font-size: 14px;
    }

    .modal-body table {
        margin-bottom: 0;
    }

    .modal-title {
        font-weight: 700;
    }

    .dash-card h3 {
        font-size: 22px;
    }


    .pagination {
        display: flex;
        justify-content: center;
        margin-top: 12px;
    }

        .pagination li {
            cursor: pointer;
            margin: 0 4px;
        }

            .pagination li.active a {
                background-color: #0d6efd;
                color: #fff;
                border-radius: 6px;
                padding: 4px 10px;
            }

            .pagination li a {
                display: block;
                padding: 4px 10px;
                border: 1px solid #dee2e6;
                border-radius: 6px;
                color: #0d6efd;
                text-decoration: none;
            }
</style>

<div class="container-fluid px-3">
    <div class="d-flex justify-content-between align-items-center">
        <h2 class="page-title"> Smart Inventory Dashboard</h2>
        <div class="mb-3">
            <button class="btn btn-outline-primary btn-refresh" onclick="loadDashboard()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
    </div>

    @*Dashboard Summary Cards coding part  *@
    <div class="row summary-row g-3">
        <div class="col-xl-3 col-md-6">
            <div class="dash-card" onclick="showDetails('products')">
                <div class="icon"><i class="bi bi-box-seam"></i></div>
                <h6>Total Products</h6>
                <h3 id="totalProducts">0</h3>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="dash-card" onclick="showDetails('categories')">
                <div class="icon"><i class="bi bi-tags"></i></div>
                <h6>Total Categories</h6>
                <h3 id="totalCategories">0</h3>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="dash-card" onclick="showDetails('lowStock')">
                <div class="icon"><i class="bi bi-exclamation-triangle"></i></div>
                <h6>Low Stock </h6>
                <h3 id="lowStock">0</h3>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="dash-card" onclick="showDetails('active')">
                <div class="icon"><i class="bi bi-check-circle"></i></div>
                <h6>Active Products</h6>
                <h3 id="activeProducts">0</h3>
            </div>
        </div>
    </div>

    <hr />

    @* Charts Section coding part *@
    <h5 class="mb-3" style="color:#343a40;font-weight:700">Visual Insights</h5>
    <div class="row g-3">
        <div class="col-lg-6">
            <div class="chart-card">
                <h6>Stock Quantity by Category</h6>
                <div class="chart-wrap"><canvas id="stockChart"></canvas></div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="chart-card">
                <h6>Category Stock Distribution</h6>
                <div class="chart-wrap">
                    <canvas id="categoryPieChart"></canvas>
                    <div id="pieTooltip"></div>
                </div>
            </div>
        </div>
    </div>

    <hr />

    @* Recent Products Table coding part *@
    <h5 class="mt-4 mb-3" style="color:#343a40;font-weight:700">Recent Products</h5>
    <div class="table-responsive">
        <table class="table table-bordered table-hover" id="recentTable">
            <thead class="table-light">
                <tr>
                    <th>Name</th>
                    <th>Category</th>
                    <th style="width:120px">Stock</th>
                    <th style="width:120px">Status</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <nav>
            <ul class="pagination" id="paginationControls"></ul>
        </nav>
    </div>
</div>

@* display details modal coding part *@
<div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel">Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table table-striped table-bordered">
                    <thead id="detailsHead"></thead>
                    <tbody id="detailsBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
                const API = '/api';
                let products = [], categories = [];
                let barChart = null, pieChart = null;

                let currentPage = 1;
                const pageSize = 10;

                async function loadDashboard() {
                    try {
                        const [pRes, cRes] = await Promise.all([
                            fetch(API + '/products'),
                            fetch(API + '/categories')
                        ]);
                        products = await pRes.json();
                        categories = await cRes.json();

         //dashboard summary cards coding part
                        document.getElementById('totalProducts').textContent = products.length;
                        document.getElementById('totalCategories').textContent = categories.length;
                        document.getElementById('lowStock').textContent = products.filter(p => p.stockQuantity < 5).length;
                        document.getElementById('activeProducts').textContent = products.filter(p => p.isActive).length;

                        renderRecentProducts(1);
                        drawCharts();
                    } catch(err) {
                        console.error("Failed to load dashboard:", err);
                    }
                }
        //recent products in table with pagination coding part

                function renderRecentProducts(page = 1) {
                    const tbody = document.querySelector('#recentTable tbody');
                    tbody.innerHTML = '';
                    currentPage = page;
                    const start = (page - 1) * pageSize;
                    const pagedProducts = products.slice().reverse().slice(start, start + pageSize);

                    pagedProducts.forEach(p => {
                        const stockHtml = p.stockQuantity < 5 ? `<span class="stock-low">${p.stockQuantity}</span>` : p.stockQuantity;
                        tbody.innerHTML += `
                            <tr>
                                <td>${escapeHtml(p.productName)}</td>
                                <td>${escapeHtml(p.categoryName)}</td>
                                <td>${stockHtml}</td>
                                <td>${p.isActive ? '<span class="badge-active">Active</span>' : '<span class="badge-inactive">Inactive</span>'}</td>
                            </tr>`;
                    });

                    renderPaginationControls(page);
                }

         //this is for Render pagination buttons

                function renderPaginationControls(page) {
                    const totalPages = Math.ceil(products.length / pageSize);
                    const container = document.getElementById('paginationControls');
                    container.innerHTML = '';
                    for (let i = 1; i <= totalPages; i++) {
                        const li = document.createElement('li');
                        li.className = `page-item ${i === page ? 'active' : ''}`;
                        li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                        li.onclick = () => renderRecentProducts(i);
                        container.appendChild(li);
                    }
                }
        // charts part
                function drawCharts() {
                    const barCtx = document.getElementById('stockChart').getContext('2d');
                    const pieCtx = document.getElementById('categoryPieChart').getContext('2d');
                    const tooltip = document.getElementById('pieTooltip');

                    if (barChart) { barChart.destroy(); barChart = null; }
                    if (pieChart) { pieChart.destroy(); pieChart = null; }

                    const labels = categories.map(c => c.name);
                    const data = categories.map(c =>
                        products.filter(p => p.categoryId === c.id).reduce((s, p) => s + (p.stockQuantity || 0), 0)
                    );

                    barChart = new Chart(barCtx, {
                        type: 'bar',
                        data: { labels, datasets: [{ label: 'Stock', data, backgroundColor: '#0d6efd', borderRadius: 6 }] },
                        options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
                    });

                    const palette = ['#ffc107','#dc3545','#198754','#0d6efd','#6f42c1','#fd7e14','#20c997','#0dcaf0'];
                    pieChart = new Chart(pieCtx, {
                        type: 'pie',
                        data: { labels, datasets: [{ data, backgroundColor: palette.slice(0, labels.length) }] },
                        options: {
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 12 } }, tooltip: { enabled: false } },
                            onHover: (evt, activeEls) => {
                                if (!activeEls.length) { tooltip.style.display='none'; return; }
                                const idx = activeEls[0].index;
                                const category = categories[idx];
                                const catProducts = products.filter(p => p.categoryId === category.id);
                                let html = `<div class="title">${escapeHtml(category.name)}</div>`;
                                if (catProducts.length) {
                                    html += catProducts.map(p => `<div class="product-line">${escapeHtml(p.productName)} <strong style="float:right;color:#198754">(${p.stockQuantity})</strong></div>`).join('');
                                } else { html += `<div class="product-line"><em>No products</em></div>`; }
                                tooltip.innerHTML = html;
                                tooltip.style.display = 'block';
                                tooltip.style.left = (evt.native.clientX + 14)+'px';
                                tooltip.style.top = (evt.native.clientY + 14)+'px';
                            }
                        }
                    });

                    pieCtx.canvas.addEventListener('mouseleave', () => { tooltip.style.display = 'none'; });
                }
        // show modal with detailed part
                function showDetails(type) {
                    const modalTitle = document.getElementById('detailsModalLabel');
                    const head = document.getElementById('detailsHead');
                    const body = document.getElementById('detailsBody');
                    head.innerHTML = ''; body.innerHTML = '';
                    let rows = [];

                    if(type==='products'){
                        modalTitle.innerText='All Products';
                        head.innerHTML='<tr><th>Name</th><th>Category</th><th>Stock</th><th>Status</th></tr>';
                        rows = products.map(p=>{
                            const stockHtml = p.stockQuantity<5?`<span class="stock-low">${p.stockQuantity}</span>`:p.stockQuantity;
                            return `<tr><td>${escapeHtml(p.productName)}</td><td>${escapeHtml(p.categoryName)}</td><td>${stockHtml}</td><td>${p.isActive?'<span class="badge-active">Active</span>':'<span class="badge-inactive">Inactive</span>'}</td></tr>`;
                        });
                    } else if(type==='categories'){
                        modalTitle.innerText='All Categories';
                        head.innerHTML='<tr><th>ID</th><th>Name</th></tr>';
                        rows = categories.map(c=>`<tr><td>${c.id}</td><td>${escapeHtml(c.name)}</td></tr>`);
                    } else if(type==='lowStock'){
                        modalTitle.innerText='Low Stock Products';
                        head.innerHTML='<tr><th>Name</th><th>Category</th><th>Stock</th></tr>';
                        rows = products.filter(p=>p.stockQuantity<5).map(p=>`<tr><td>${escapeHtml(p.productName)}</td><td>${escapeHtml(p.categoryName)}</td><td><span class="stock-low">${p.stockQuantity}</span></td></tr>`);
                    } else if(type==='active'){
                        modalTitle.innerText='Active Products';
                        head.innerHTML='<tr><th>Name</th><th>Category</th></tr>';
                        rows = products.filter(p=>p.isActive).map(p=>`<tr><td>${escapeHtml(p.productName)}</td><td>${escapeHtml(p.categoryName)}</td></tr>`);
                    }

                    body.innerHTML = rows.join('');
                    new bootstrap.Modal(document.getElementById('detailsModal')).show();
                }

                function escapeHtml(str){ if(!str && str!==0)return''; return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;"); }

                window.addEventListener('load',()=>{
                    loadDashboard();

        // dashboard page loading part
                    window.addEventListener('resize',()=>{
                        if(barChart)barChart.resize();
                        if(pieChart)pieChart.resize();
                    });
                });
    </script>
}
